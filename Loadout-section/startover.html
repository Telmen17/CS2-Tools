<script>
    (() => {
        const DROPS = [...document.querySelectorAll('.dropdown')];

        // ---- Global state ----
        let slots = {};  // slotId -> pistol
        let availablePistols = [
            { name: "Five-SeveN", price: 500 },
            { name: "CZ75-Auto", price: 300 },
            { name: "Tec-9", price: 300 },
            { name: "R8 Revolver", price: 600 },
            { name: "Desert Eagle", price: 700 }
        ];

        // Initialize slots with their starting pistols
        document.querySelectorAll('.category:nth-of-type(2) .item-card').forEach((card, i) => {
            const h3 = card.querySelector('h3').textContent.trim();
            const price = card.dataset.price;
            slots[i] = { name: h3, price: parseInt(price) };
        });

        // ---- Menu rendering ----
        function renderMenus() {
            DROPS.forEach((dropdown, idx) => {
                const menu = dropdown.querySelector('.dropdown__menu');
                menu.innerHTML = ""; // clear

                availablePistols.forEach(pistol => {
                    const btn = document.createElement("button");
                    btn.className = "dropdown__item";
                    btn.dataset.value = pistol.name;
                    btn.dataset.price = pistol.price;
                    btn.textContent = `${pistol.name} ($${pistol.price})`;
                    btn.addEventListener("click", () => handleSelect(idx, pistol));
                    menu.appendChild(btn);
                });
            });
        }

        // ---- Selection handler ----
        function handleSelect(slotId, pistol) {
            const card = document.querySelectorAll('.category:nth-of-type(2) .item-card')[slotId];
            const oldPistol = slots[slotId];

            // Return old to pool
            if (oldPistol) {
                availablePistols.push(oldPistol);
            }

            // Remove new from pool
            availablePistols = availablePistols.filter(p => p.name !== pistol.name);

            // Assign new
            slots[slotId] = pistol;

            // Update UI
            card.dataset.price = pistol.price;
            card.querySelector("h3").textContent = pistol.name;
            card.querySelector("p").textContent = `$${pistol.price}`;
            const imageName = pistol.name.toLowerCase().replace(/ /g, "-").replace(/[^a-z0-9-]/g, "");
            card.querySelector("img").src = `https://gamestatlab.com/wp-content/uploads/2025/08/${imageName}.png`;

            // Re-render menus
            renderMenus();
        }

        // ---- Dropdown toggle wiring ----
        DROPS.forEach((dropdown) => {
            const btn = dropdown.querySelector('.dropdown__button');
            const menu = dropdown.querySelector('.dropdown__menu');

            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                menu.classList.toggle('is-open');
                dropdown.classList.toggle('is-open');
            });

            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    menu.classList.remove('is-open');
                    dropdown.classList.remove('is-open');
                }
            });
        });

        // Init menus
        renderMenus();
    })();
</script>
